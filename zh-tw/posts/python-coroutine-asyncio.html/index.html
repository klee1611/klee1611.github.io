<!doctype html><html lang=zh-TW><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Python Coroutine Asyncio - Kourtney's Blog</title><meta name=Description content="A blog about programming, technology, and life."><meta property="og:url" content="https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/"><meta property="og:site_name" content="Kourtney's Blog"><meta property="og:title" content="Python Coroutine Asyncio"><meta property="og:description" content="在出現 asyncio 前，
當一隻 Python 程式有很多需要並行執行的 task，
想要提升程式效能，
只能選用 multiprocessing 或 threading；
Python 3.4 之後又多出了 asyncio 的選擇。
asyncio 可以用來撰寫 coroutines，
並使用 event loop 並行執行 coroutines，
減少程式不必要的等待時間以提升效能。"><meta property="og:locale" content="zh_TW"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-27T16:39:27+08:00"><meta property="article:modified_time" content="2021-10-27T17:06:08+08:00"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Python"><meta property="article:tag" content="Concurrent Processing"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python Coroutine Asyncio"><meta name=twitter:description content="在出現 asyncio 前，
當一隻 Python 程式有很多需要並行執行的 task，
想要提升程式效能，
只能選用 multiprocessing 或 threading；
Python 3.4 之後又多出了 asyncio 的選擇。
asyncio 可以用來撰寫 coroutines，
並使用 event loop 並行執行 coroutines，
減少程式不必要的等待時間以提升效能。"><meta name=application-name content="Kourtney's Blog"><meta name=apple-mobile-web-app-title content="Kourtney's Blog"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/><link rel=prev href=https://klee1611.github.io/zh-tw/posts/pipenv-notes.html/><link rel=next href=https://klee1611.github.io/zh-tw/posts/pyenv-notes.html/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="WLcU5DjZJSqz0doT_JYXHt6H-4I0EE_iWnsqFqyO1E0"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Python Coroutine Asyncio","inLanguage":"zh-TW","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/klee1611.github.io\/zh-tw\/posts\/python-coroutine-asyncio.html\/"},"genre":"posts","keywords":"Programming, Python, Concurrent Processing","wordcount":1095,"url":"https:\/\/klee1611.github.io\/zh-tw\/posts\/python-coroutine-asyncio.html\/","datePublished":"2021-10-27T16:39:27+08:00","dateModified":"2021-10-27T17:06:08+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Kourtney Lee"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>const query=window.matchMedia("(prefers-color-scheme: dark)");function applyTheme(){let e=window.localStorage?.getItem("theme")||"dark",t=e==="dark"||e==="auto"&&query.matches;document.body.setAttribute("theme",t?"dark":"light"),document.body.setAttribute("cfg-theme",e)}applyTheme(),query.addEventListener("change",applyTheme)</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/zh-tw/ title="Kourtney's Blog">Kourtney's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=https://github.com/klee1611 rel="noopener noreffer" target=_blank><i class='fab fa-fw fa-github'></i> GitHub </a><a class=menu-item href=/zh-tw/posts/>文章 </a><a class=menu-item href=/zh-tw/tags/>標簽 </a><a class=menu-item href=/zh-tw/categories/>分類 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章標題或內容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切換主題><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><span class="menu-item language" title=選擇語言><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/posts/python-coroutine-asyncio.html/>English</option><option value=/zh-tw/posts/python-coroutine-asyncio.html/ selected>繁體中文</option></select></span></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/zh-tw/ title="Kourtney's Blog">Kourtney's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章標題或內容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=https://github.com/klee1611 title rel="noopener noreffer" target=_blank><i class='fab fa-fw fa-github'></i>GitHub</a><a class=menu-item href=/zh-tw/posts/ title>文章</a><a class=menu-item href=/zh-tw/tags/ title>標簽</a><a class=menu-item href=/zh-tw/categories/ title>分類</a><a href=javascript:void(0); class="menu-item theme-switch" title=切換主題>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><span class=menu-item title=選擇語言><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/posts/python-coroutine-asyncio.html/>English</option><option value=/zh-tw/posts/python-coroutine-asyncio.html/ selected>繁體中文</option></select></span></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目錄</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Python Coroutine Asyncio</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/zh-tw/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Kourtney Lee</a></span>&nbsp;<span class=post-category>收錄於 <a href=/zh-tw/categories/concurrency-programming/><i class="far fa-folder fa-fw" aria-hidden=true></i>Concurrency Programming</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-10-27>2021-10-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;約 1095 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;預計閱讀 3 分鐘&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目錄</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#coroutines>Coroutines</a><ul><li><a href=#coroutine-定義>Coroutine 定義</a></li><li><a href=#用-async-await-和-asynciorun-定義並執行-coroutine>用 async, await 和 asyncio.run 定義並執行 coroutine</a></li></ul></li><li><a href=#event-loop>Event Loop</a><ul><li><a href=#what-is-event-loop>What is event loop</a></li><li><a href=#以-event-loop-執行-coroutines>以 Event loop 執行 coroutines</a></li></ul></li><li><a href=#效能測量>效能測量</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>在出現 <code>asyncio</code> 前，<br>當一隻 Python 程式有很多需要並行執行的 task，<br>想要提升程式效能，<br>只能選用 multiprocessing 或 threading；<br>Python 3.4 之後又多出了 <code>asyncio</code> 的選擇。<br><code>asyncio</code> 可以用來撰寫 coroutines，<br>並使用 event loop 並行執行 coroutines，<br>減少程式不必要的等待時間以提升效能。</p><h2 id=coroutines>Coroutines</h2><h3 id=coroutine-定義>Coroutine 定義</h3><p>在 <a href=https://docs.python.org/3/glossary.html#term-coroutine target=_blank rel="noopener noreffer">Python 官方文件</a> 定義裡，<br>Python coroutines 是</p><blockquote><p>Coroutines are a more generalized form of subroutines. Subroutines are entered at one point and exited at another point. Coroutines can be entered, exited, and resumed at many different points. They can be implemented with the async def statement. See also PEP 492.</p></blockquote><p>意指 Python 的 coroutine 和 subroutines 相當類似，<br>不同的地方在於 subroutine 是開始之後直接一次執行到底，<br>執行完後結束；<br>而 coroutine 則可以執行到某處暫停，<br>之後再繼續恢復執行。</p><h3 id=用-async-await-和-asynciorun-定義並執行-coroutine>用 async, await 和 asyncio.run 定義並執行 coroutine</h3><p><code>async</code> 可以用來定義一個 coroutine，<br>只要在定義 function 的 <code>def</code> 前加上 <code>async</code> 就可以用 <code>async def</code> 定義一個 coroutine。<br><code>await</code> 用來定義一個 coroutine 的暫停處，<br>執行到 <code>await</code> 時，<br>coroutine 就可以暫停，<br>之後再恢復執行。</p><p><code>await</code> 後面只能接 awaitable object，<br>awaitable object 包含 coroutine 或 event loop 的 task 等。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-python"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>ten_sec_sleep</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;10 sec sleep finish&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>ten_sec_sleep</span><span class=p>())</span></span></span></code></pre></div></div><h2 id=event-loop>Event Loop</h2><h3 id=what-is-event-loop>What is event loop</h3><p>在 <a href=https://docs.python.org/3/glossary.html#term-coroutine target=_blank rel="noopener noreffer">Python 官方文件</a> 裡，<br>介紹的 Event loop</p><blockquote><p>The event loop is the core of every asyncio application. Event loops run asynchronous tasks and callbacks, perform network IO operations, and run subprocesses.</p></blockquote><p>簡單來說就是用來跑異步執行的 task 的。</p><p>Event loop 每次只會執行一個 task，<br>使用 event loop 跑 coroutines 時，<br>當 task 執行到 programmer 定義的暫停處，<br>event loop 會將該 task 暫停並排程，<br>接著切換執行其他的工作（可能是其他的 task 或 callback 等），<br>這也使得 <strong>event loop 和 coroutine 的組合特別適合用來處理 IO bound task；</strong><br>將 coroutine I/O 運作的部分定為暫停處，<br>並使用 event loop 來跑這些 coroutines 時就能夠將等待 I/O 的時間切換做其他的工作。</p><h3 id=以-event-loop-執行-coroutines>以 Event loop 執行 coroutines</h3><p>執行單一一個 coroutine：</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-python"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>ten_sec_sleep</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;10 sec sleep finish, count: </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>loop</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>task</span> <span class=o>=</span> <span class=n>loop</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=n>ten_sec_sleep</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>loop</span><span class=o>.</span><span class=n>run_until_complete</span><span class=p>(</span><span class=n>task</span><span class=p>)</span></span></span></code></pre></div></div><p>執行時間用 <code>time</code> command 看是 <code>10.09</code> 秒</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><pre tabindex=0><code>10 sec sleep finish, count: 0
       10.09 real         0.06 user         0.01 sys</code></pre></div><p>多個 coroutine 並行執行：</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-python"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>ten_sec_sleep</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;10 sec sleep finish, count: </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>loop</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>tasks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>tasks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>loop</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=n>ten_sec_sleep</span><span class=p>(</span><span class=n>i</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>loop</span><span class=o>.</span><span class=n>run_until_complete</span><span class=p>(</span><span class=n>asyncio</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>tasks</span><span class=p>))</span></span></span></code></pre></div></div><p>每當執行到 <code>sleep(10)</code> 的時候 event loop 就可以切換到其他 coroutine 去執行，</p><p>並行執行 coroutine 的時間用 <code>time</code> command 看是 <code>10.09</code> 秒</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><pre tabindex=0><code>10 sec sleep finish, count: 0
10 sec sleep finish, count: 1
10 sec sleep finish, count: 2
10 sec sleep finish, count: 3
10 sec sleep finish, count: 4
10 sec sleep finish, count: 5
10 sec sleep finish, count: 6
10 sec sleep finish, count: 7
10 sec sleep finish, count: 8
10 sec sleep finish, count: 9
10.09 real         0.07 user         0.01 sys</code></pre></div><h2 id=效能測量>效能測量</h2><p>一支連續發 10 個 requests 到 google 的程式，
在不使用 coroutine 的情況下：</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-python"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>issue_req</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http://www.google.com.tw&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;count: </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s1>, resp status: </span><span class=si>{</span><span class=n>resp</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>issue_req</span><span class=p>(</span><span class=n>i</span><span class=p>)</span></span></span></code></pre></div></div><p>用 <code>time</code> command 看需要的時間是 <code>0.83</code> 秒</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><pre tabindex=0><code>count: 0, resp status: 200
count: 1, resp status: 200
count: 2, resp status: 200
count: 3, resp status: 200
count: 4, resp status: 200
count: 5, resp status: 200
count: 6, resp status: 200
count: 7, resp status: 200
count: 8, resp status: 200
count: 9, resp status: 200
        0.83 real         0.16 user         0.05 sys</code></pre></div><p>使用 coroutine 來並行發出 requests：</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-python"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>issue_req</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>loop</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=k>await</span> <span class=n>loop</span><span class=o>.</span><span class=n>run_in_executor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;http://www.google.com.tw&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;count: </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s1>, resp status: </span><span class=si>{</span><span class=n>resp</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>loop</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>tasks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>tasks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>loop</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=n>issue_req</span><span class=p>(</span><span class=n>i</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>loop</span><span class=o>.</span><span class=n>run_until_complete</span><span class=p>(</span><span class=n>asyncio</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>tasks</span><span class=p>))</span></span></span></code></pre></div></div><p>用 <code>time</code> command 看需要的時間是 <code>0.31</code> 秒</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=複製到剪貼板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><pre tabindex=0><code>count: 0, resp status: 200
count: 2, resp status: 200
count: 3, resp status: 200
count: 7, resp status: 200
count: 5, resp status: 200
count: 1, resp status: 200
count: 9, resp status: 200
count: 6, resp status: 200
count: 8, resp status: 200
count: 4, resp status: 200
        0.31 real         0.18 user         0.05 sys</code></pre></div><p>以這 10 個 requests 來看，<br>從 <code>0.83</code> 秒到 <code>0.31</code> 秒，<br>效能提升了 <code>(0.83 - 0.31)/0.83 * 100% = 62.65%</code> ，<br>相當顯著；<br>對有相當多 I/O bound task 的程式來說，<br>使用 coroutine 是個不錯的選擇。</p></div><div id=buy-me-a-coffee align=center style=margin-top:5vh><script type=text/javascript src=https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js data-name=bmc-button data-slug=klee1611 data-color=#FFDD00 data-emoji data-font=Bree data-text="Buy me a coffee" data-outline-color=#000000 data-font-color=#000000 data-coffee-color=#ffffff></script></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新於 2021-10-27</span></div><div id=page-views class=post-info-mod></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=x data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/ data-title="Python Coroutine Asyncio" data-via=KourtneyLee1611 data-hashtags="Programming,Python,Concurrent Processing"><i class="fab fa-x-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Threads" data-sharer=threads data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/ data-title="Python Coroutine Asyncio"><i class="fab fa-threads fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/ data-hashtag=Programming><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/><i class="fab fa-linkedin-in fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/ data-title="Python Coroutine Asyncio" data-web><i class="fab fa-whatsapp fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/ data-title="Python Coroutine Asyncio"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/ data-title="Python Coroutine Asyncio"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@15.14.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/ data-title="Python Coroutine Asyncio"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Diaspora" data-sharer=diaspora data-url=https://klee1611.github.io/zh-tw/posts/python-coroutine-asyncio.html/ data-title="Python Coroutine Asyncio" data-description><i class="fab fa-diaspora fa-fw" aria-hidden=true></i></a><a href="https://t.me/share/url?url=https%3a%2f%2fklee1611.github.io%2fzh-tw%2fposts%2fpython-coroutine-asyncio.html%2f&amp;text=Python%20Coroutine%20Asyncio" target=_blank title="分享到 Telegram"><i class="fab fa-telegram fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/zh-tw/tags/programming/>Programming</a>,&nbsp;<a href=/zh-tw/tags/python/>Python</a>,&nbsp;<a href=/zh-tw/tags/concurrent-processing/>Concurrent Processing</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/zh-tw/>主頁</a></span></section></div><div class=post-nav><a href=/zh-tw/posts/pipenv-notes.html/ class=prev rel=prev title="Pipenv Notes"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Pipenv Notes</a>
<a href=/zh-tw/posts/pyenv-notes.html/ class=next rel=next title="Pyenv Notes">Pyenv Notes<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=gitalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/gitalk/gitalk>Gitalk</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.151.2">Hugo</a> 強力驅動 | 主題 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/zh-tw/ target=_blank>Kourtney Lee</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到頂部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title=查看評論><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script src=/lib/lunr/lunr.stemmer.support.min.js></script><script src=/lib/lunr/lunr.zh.min.js></script><script src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js></script><script>window.config={comment:{gitalk:{admin:["klee1611"],clientID:"9039cf9e5ad3113a26a0",clientSecret:"f7944019c2817fafd830792a4b68d2c38ff69521",id:"2021-10-27T16:39:27+08:00",owner:"klee1611",repo:"klee1611.github.io",title:"Python Coroutine Asyncio"}},search:{highlightTag:"em",lunrIndexURL:"/zh-tw/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"沒有找到結果",snippetLength:30,type:"lunr"}}</script><script src=/js/theme.min.js></script></body></html>